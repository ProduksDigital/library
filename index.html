<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LibreDesk - Personal PDF Library</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap');

        :root {
            --primary: #d4af37;
            --bg-dark: #050505;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e5e5;
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .serif { font-family: 'Playfair Display', serif; }

        /* Ghost UI Animation */
        .ghost-ui {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
            z-index: 2100;
        }
        .ghost-ui.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .ui-top { transform: translateY(-25px); }
        .ui-bottom { transform: translateY(25px); }
        .visible.ui-top, .visible.ui-bottom { transform: translateY(0); }

        /* Perfect Fit Reader */
        #reader-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 2000;
            overflow: hidden;
        }

        .reader-viewport {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden; /* Mencegah geser horizontal */
            background: #000;
            scroll-behavior: smooth;
        }

        #pdf-canvas {
            width: 100vw !important; /* Paksa lebar pas layar */
            height: auto !important;
            display: block;
        }

        .glass-panel {
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .cat-btn {
            white-space: nowrap;
            padding: 8px 20px;
            border-radius: 14px;
            background: rgba(255,255,255,0.05);
            font-size: 0.85rem;
            transition: 0.3s;
            border: 1px solid transparent;
        }
        .cat-btn.active { 
            background: var(--primary); 
            color: #000; 
            font-weight: 700;
            border-color: var(--primary);
        }

        .book-card { transition: all 0.3s ease; }
        .book-card:hover { transform: translateY(-8px); }
    </style>
</head>
<body>

    <!-- Library Header -->
    <header class="sticky top-0 z-[100] px-6 py-5 bg-black/60 backdrop-blur-2xl border-b border-white/5">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-5">
            <div class="flex items-center gap-3 shrink-0">
                <div class="w-11 h-11 bg-amber-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-500/20">
                    <i class="fas fa-book-open text-black text-xl"></i>
                </div>
                <h1 class="text-2xl serif font-bold tracking-tight">LibreDesk<span class="text-amber-500">.</span></h1>
            </div>

            <!-- Search System -->
            <div class="w-full max-w-xl relative group">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-amber-500"></i>
                <input type="text" id="main-search" oninput="renderLibrary()" placeholder="Cari judul, penulis, atau kategori..." 
                    class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 pl-12 pr-4 focus:outline-none focus:border-amber-500/50 transition-all text-sm">
            </div>

            <button onclick="toggleUploadModal(true)" class="bg-white text-black px-7 py-3 rounded-2xl font-bold text-xs hover:bg-amber-500 transition-all shrink-0 shadow-xl shadow-white/5">
                <i class="fas fa-plus mr-2"></i> Tambah Buku
            </button>
        </div>
    </header>

    <!-- Categories -->
    <div class="container mx-auto px-6 py-6 overflow-x-auto no-scrollbar flex gap-4" id="category-bar">
        <!-- JS rendered categories -->
    </div>

    <!-- Book Shelf -->
    <main class="container mx-auto px-6 pb-24">
        <div id="book-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-8"></div>
        <div id="empty-state" class="hidden flex flex-col items-center justify-center py-40 opacity-30 italic">
            <i class="fas fa-folder-open text-5xl mb-4"></i>
            <p>Belum ada koleksi di kategori ini.</p>
        </div>
    </main>

    <!-- Reader Overlay (Ghost UI) -->
    <div id="reader-overlay">
        <!-- Top Controls -->
        <div id="ui-top" class="ghost-ui ui-top fixed top-0 left-0 w-full p-6 flex justify-between items-center">
            <button onclick="closeReader(event)" class="w-12 h-12 rounded-full glass-panel flex items-center justify-center text-white text-lg">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="glass-panel px-6 py-2 rounded-2xl text-center shadow-2xl">
                <p id="read-title" class="text-[10px] font-bold text-amber-500 uppercase tracking-widest truncate max-w-[160px]">Judul Buku</p>
                <p id="read-page" class="text-[9px] text-gray-400 font-medium">Halaman 1 / 1</p>
            </div>
            <button onclick="toggleFavorite(event)" id="fav-btn" class="w-12 h-12 rounded-full glass-panel flex items-center justify-center text-white">
                <i class="fas fa-heart"></i>
            </button>
        </div>

        <!-- Scrollable Reader Area -->
        <div class="reader-viewport no-scrollbar" onclick="toggleGhostUI()">
            <canvas id="pdf-canvas"></canvas>
        </div>

        <!-- Bottom Navigation -->
        <div id="ui-bottom" class="ghost-ui ui-bottom fixed bottom-12 left-0 w-full flex justify-center">
            <div class="glass-panel px-5 py-3 flex items-center gap-8 rounded-full shadow-2xl">
                <button onclick="changePage(-1, event)" class="p-2 text-white hover:text-amber-500 transition-colors"><i class="fas fa-arrow-left text-xl"></i></button>
                <div class="w-32 h-1 bg-white/10 rounded-full overflow-hidden">
                    <div id="read-progress" class="h-full bg-amber-500 transition-all duration-300"></div>
                </div>
                <button onclick="changePage(1, event)" class="p-2 text-white hover:text-amber-500 transition-colors"><i class="fas fa-arrow-right text-xl"></i></button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black/95 hidden z-[3000] flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="bg-[#111] w-full max-w-sm rounded-[40px] p-10 border border-white/10 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl serif font-bold text-white text-center w-full">Unggah Koleksi</h3>
            </div>
            
            <div class="space-y-5">
                <input type="file" id="pdf-input" accept="application/pdf" class="hidden" onchange="handleFileSelected()">
                <label for="pdf-input" class="block border-2 border-dashed border-white/10 rounded-3xl p-10 text-center cursor-pointer bg-white/5 hover:border-amber-500/40 transition-all">
                    <i class="fas fa-cloud-upload-alt text-3xl text-amber-500 mb-3"></i>
                    <p id="file-label" class="text-xs text-gray-500 font-medium tracking-wide">PILIH FILE PDF</p>
                </label>

                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-bold text-gray-500 ml-2">Judul</label>
                    <input type="text" id="book-title" placeholder="Nama buku..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-amber-500 transition-all">
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] uppercase font-bold text-gray-500 ml-2">Kategori</label>
                    <input type="text" id="book-category" list="cat-list" placeholder="Tulis kategori baru/pilih..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-sm focus:outline-none focus:border-amber-500 transition-all">
                    <datalist id="cat-list">
                        <option value="Fiksi"><option value="Edukasi"><option value="Teknologi"><option value="Bisnis">
                    </datalist>
                </div>

                <div class="pt-4 flex flex-col gap-3">
                    <button onclick="saveBook()" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-bold py-4 rounded-2xl transition-all shadow-lg shadow-amber-600/10 text-sm">SIMPAN KOLEKSI</button>
                    <button onclick="toggleUploadModal(false)" class="w-full text-gray-500 text-[10px] font-black uppercase tracking-[0.2em]">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js Worker Configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let db, pdfDoc = null, currentPage = 1, activeId = null, uiVisible = false;
        let currentFilter = 'Semua';

        // 1. Initialize Database (IndexedDB)
        const request = indexedDB.open('LibreDeskDatabase', 1);
        request.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('books')) {
                db.createObjectStore('books', { keyPath: 'id' });
            }
        };
        request.onsuccess = e => {
            db = e.target.result;
            renderLibrary();
        };

        // 2. Upload Logic
        function toggleUploadModal(show) { 
            document.getElementById('upload-modal').classList.toggle('hidden', !show); 
        }

        function handleFileSelected() {
            const file = document.getElementById('pdf-input').files[0];
            if(file) {
                document.getElementById('file-label').innerText = file.name;
                document.getElementById('book-title').value = file.name.replace('.pdf', '');
            }
        }

        async function saveBook() {
            const file = document.getElementById('pdf-input').files[0];
            const title = document.getElementById('book-title').value;
            const category = document.getElementById('book-category').value || 'Lainnya';
            
            if(!file || !title) return;

            const reader = new FileReader();
            reader.onload = e => {
                const tx = db.transaction('books', 'readwrite');
                tx.objectStore('books').add({
                    id: Date.now(),
                    title: title,
                    category: category,
                    blob: e.target.result,
                    lastPage: 1,
                    isFavorite: false,
                    dateAdded: Date.now()
                });
                tx.oncomplete = () => {
                    toggleUploadModal(false);
                    renderLibrary();
                };
            };
            reader.readAsArrayBuffer(file);
        }

        // 3. Library Rendering with Search & Category
        function renderLibrary() {
            const tx = db.transaction('books', 'readonly');
            tx.objectStore('books').getAll().onsuccess = e => {
                const allBooks = e.target.result;
                
                // Update Category Bar Dynamically
                const categories = ['Semua', ...new Set(allBooks.map(b => b.category))];
                const bar = document.getElementById('category-bar');
                bar.innerHTML = '';
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = `cat-btn ${currentFilter === cat ? 'active' : ''}`;
                    btn.innerText = cat;
                    btn.onclick = () => { currentFilter = cat; renderLibrary(); };
                    bar.appendChild(btn);
                });

                // Filtering & Search
                const searchVal = document.getElementById('main-search').value.toLowerCase();
                const filtered = allBooks.filter(b => 
                    (currentFilter === 'Semua' || b.category === currentFilter) &&
                    (b.title.toLowerCase().includes(searchVal) || b.category.toLowerCase().includes(searchVal))
                ).sort((a,b) => b.dateAdded - a.dateAdded);

                const grid = document.getElementById('book-grid');
                grid.innerHTML = '';
                
                if(filtered.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                    filtered.forEach(b => {
                        const card = document.createElement('div');
                        card.className = 'book-card flex flex-col cursor-pointer';
                        card.innerHTML = `
                            <div class="aspect-[3/4] bg-[#111] rounded-[24px] p-6 flex items-center justify-center text-center shadow-lg border border-white/5 relative overflow-hidden group" onclick="openReader(${b.id})">
                                <span class="serif font-bold text-xs text-gray-400 group-hover:text-amber-500 transition-all duration-500 leading-relaxed">${b.title}</span>
                                ${b.isFavorite ? '<i class="fas fa-heart absolute top-4 right-4 text-red-500 text-[10px]"></i>' : ''}
                                <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </div>
                            <div class="mt-4 flex justify-between items-start px-1">
                                <div class="truncate">
                                    <h4 class="text-xs font-bold truncate text-gray-200">${b.title}</h4>
                                    <p class="text-[9px] text-gray-600 font-black uppercase mt-1 tracking-tighter">${b.category}</p>
                                </div>
                                <button onclick="deleteBook(${b.id})" class="text-gray-800 hover:text-red-500 transition-colors p-1"><i class="fas fa-trash-alt text-[10px]"></i></button>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }
            };
        }

        function deleteBook(id) {
            if(confirm("Hapus buku ini secara permanen?")) {
                const tx = db.transaction('books', 'readwrite');
                tx.objectStore('books').delete(id);
                tx.oncomplete = () => renderLibrary();
            }
        }

        // 4. Perfect Fit Reader Core
        async function openReader(id) {
            activeId = id;
            const tx = db.transaction('books', 'readonly');
            tx.objectStore('books').get(id).onsuccess = async e => {
                const book = e.target.result;
                document.getElementById('reader-overlay').style.display = 'block';
                document.getElementById('read-title').innerText = book.title;
                
                const loadingTask = pdfjsLib.getDocument({ data: book.blob });
                pdfDoc = await loadingTask.promise;
                currentPage = book.lastPage || 1;
                
                renderPage();
            };
        }

        async function renderPage() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(currentPage);
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            
            // Logika Auto Screen Fit (Fit to Width)
            const viewportWidth = window.innerWidth;
            const originalViewport = page.getViewport({ scale: 1 });
            const scale = viewportWidth / originalViewport.width;
            
            // Device Pixel Ratio untuk ketajaman
            const dpr = window.devicePixelRatio || 1;
            const viewport = page.getViewport({ scale: scale * dpr });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;

            // UI Updates
            document.getElementById('read-page').innerText = `Halaman ${currentPage} / ${pdfDoc.numPages}`;
            document.getElementById('read-progress').style.width = `${(currentPage / pdfDoc.numPages) * 100}%`;
            
            saveProgress();
        }

        function toggleGhostUI() {
            uiVisible = !uiVisible;
            document.getElementById('ui-top').classList.toggle('visible', uiVisible);
            document.getElementById('ui-bottom').classList.toggle('visible', uiVisible);
        }

        function changePage(dir, e) {
            if(e) e.stopPropagation();
            const next = currentPage + dir;
            if(next >= 1 && next <= pdfDoc.numPages) {
                currentPage = next;
                renderPage();
                document.querySelector('.reader-viewport').scrollTop = 0;
            }
        }

        function saveProgress() {
            const tx = db.transaction('books', 'readwrite');
            const store = tx.objectStore('books');
            store.get(activeId).onsuccess = e => {
                const b = e.target.result;
                b.lastPage = currentPage;
                store.put(b);
                document.getElementById('fav-btn').classList.toggle('text-red-500', b.isFavorite);
            };
        }

        function toggleFavorite(e) {
            e.stopPropagation();
            const tx = db.transaction('books', 'readwrite');
            const store = tx.objectStore('books');
            store.get(activeId).onsuccess = e => {
                const b = e.target.result;
                b.isFavorite = !b.isFavorite;
                store.put(b);
                document.getElementById('fav-btn').classList.toggle('text-red-500', b.isFavorite);
            };
        }

        function closeReader(e) {
            if(e) e.stopPropagation();
            document.getElementById('reader-overlay').style.display = 'none';
            uiVisible = false;
            renderLibrary();
        }

        // Responsive Re-fit
        window.addEventListener('resize', () => {
            if(document.getElementById('reader-overlay').style.display === 'block') {
                renderPage();
            }
        });

        // Keybinds
        document.addEventListener('keydown', e => {
            if(document.getElementById('reader-overlay').style.display === 'block') {
                if(e.key === 'ArrowRight') changePage(1);
                if(e.key === 'ArrowLeft') changePage(-1);
                if(e.key === 'Escape') closeReader();
            }
        });
    </script>
</body>
</html>
